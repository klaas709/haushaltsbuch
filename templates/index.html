{% extends "base.html" %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-list">
      {% for cat, msg in messages %}
        <div class="flash {{ cat }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="hero">
  <h1>√úbersicht & Erfassung</h1>
  <p class="muted">Betr√§ge im deutschen Format: <code>2.100</code> oder <code>12,34</code> ‚Äî Vorzeichen wird √ºber <em>Einnahme/Ausgabe</em> gesetzt.</p>
</section>

<!-- Neuer Eintrag -->
<section class="card">
  <h2>‚ûï Neuer Eintrag</h2>
  <form class="form-grid" action="{{ url_for('add_entry_route') }}" method="post" novalidate>
    <label>
      <span>Datum</span>
      <input type="date" name="date" value="{{ today }}" required>
    </label>
    <label>
      <span>Kategorie</span>
      <select name="category" required>
        <option value="" disabled selected>Bitte w√§hlen‚Ä¶</option>
        {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
      </select>
    </label>
    <label class="full">
      <span>Art</span>
      <div class="type-toggle">
        <label><input type="radio" name="type" value="income"> Einnahme</label>
        <label><input type="radio" name="type" value="expense"> Ausgabe</label>
      </div>
    </label>
    <label>
      <span>Betrag (‚Ç¨)</span>
      <input type="text" name="amount" placeholder="z. B. 2.100 oder 12,34" inputmode="decimal" required>
    </label>
    <label class="full">
      <span>Notiz (optional)</span>
      <input type="text" name="note" placeholder="z. B. Wocheneinkauf">
    </label>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Speichern</button>
    </div>
  </form>
</section>

<!-- Filter -->
<section class="card">
  <h2>üîé Filter</h2>
  <form class="filters" action="{{ url_for('home') }}" method="get">
    <label>
      <span>Kategorie</span>
      <select name="category">
        <option value="">Alle</option>
        {% for c in categories %}<option value="{{ c }}" {% if filters.category == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
      </select>
    </label>
    <label>
      <span>Art</span>
      <div class="chip-toggle">
        <label class="chip"><input type="radio" name="type" value="" {% if not filters.type %}checked{% endif %}><span>Alle</span></label>
        <label class="chip"><input type="radio" name="type" value="income" {% if filters.type == 'income' %}checked{% endif %}><span>Einnahmen</span></label>
        <label class="chip"><input type="radio" name="type" value="expense" {% if filters.type == 'expense' %}checked{% endif %}><span>Ausgaben</span></label>
      </div>
    </label>
    <label>
      <span>Datum von</span>
      <input type="date" name="date_from" value="{{ filters.date_from }}">
    </label>
    <label>
      <span>Datum bis</span>
      <input type="date" name="date_to" value="{{ filters.date_to }}">
    </label>
    <label class="full">
      <span>Textsuche (Notiz enth√§lt)</span>
      <input type="text" name="q" placeholder="z. B. 'Supermarkt' oder 'Miete'" value="{{ filters.q }}">
    </label>
    <div class="actions">
      <button class="btn" type="submit">Filtern</button>
      <a class="btn btn-ghost" href="{{ url_for('home') }}">Zur√ºcksetzen</a>
      <a class="btn" href="{{ url_for('export_csv') }}{% if query_str %}?{{ query_str }}{% endif %}">CSV exportieren</a>
    </div>
  </form>
  <p class="muted" style="margin-top:8px;">{{ result_count }} Ergebnis{{ '' if result_count == 1 else 'se' }} gefunden.</p>
</section>

<!-- √úbersicht -->
<section class="card">
  <h2>üìä √úbersicht</h2>
  <div class="summary">
    <div><strong>Einnahmen:</strong> <span class="pos">{{ total_income|euro }} ‚Ç¨</span></div>
    <div><strong>Ausgaben:</strong> <span class="neg">{{ total_expense|euro }} ‚Ç¨</span></div>
    <div><strong>Saldo:</strong> {{ balance|euro }} ‚Ç¨</div>
  </div>

  {% if entries and entries|length > 0 %}
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Kategorie</th>
            <th class="right">Betrag</th>
            <th>Notiz</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entries %}
            <tr>
              <td>{{ e.date }}</td>
              <td>
                <span class="badge badge-cat">{{ e.category }}</span>
              </td>
              <td class="right {{ 'neg' if e.amount < 0 else 'pos' }}">{{ e.amount|euro }} ‚Ç¨</td>
              <td>{{ e.note }}</td>
              <td class="actions">
                <a class="btn btn-small" href="{{ url_for('edit_entry', entry_id=e.id) }}">‚úè Bearbeiten</a>
                <form action="{{ url_for('delete_entry_route', entry_id=e.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Diesen Eintrag wirklich l√∂schen?');">
                  <button class="btn btn-small btn-ghost" type="submit">üóë L√∂schen</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty">
      <div class="empty-illustration">üì≠</div>
      <p class="muted">Keine Eintr√§ge f√ºr die aktuelle Filterauswahl. Lege oben einen neuen Eintrag an.</p>
    </div>
  {% endif %}
</section>

<!-- Alle Eintr√§ge l√∂schen -->
<section class="card danger">
  <h2>Alle Eintr√§ge l√∂schen</h2>
  <p class="muted">
    Hier kannst du <strong>alle</strong> deine Eintr√§ge unwiderruflich l√∂schen.
    Zur Best√§tigung gib bitte dein Passwort ein.
  </p>
  <form action="{{ url_for('clear_entries') }}" method="post" class="form-inline" novalidate>
    <input type="password" name="password" placeholder="Passwort" required>
    <button class="btn btn-danger" type="submit"
            onclick="return confirm('Wirklich ALLE Eintr√§ge l√∂schen? Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden.');">
      Alle Eintr√§ge l√∂schen
    </button>
  </form>
</section>

<!-- FAB Quick Add (v1.7) -->
<button class="fab" id="fabAdd" aria-label="Schnell hinzuf√ºgen">Ôºã</button>
<div class="modal" id="quickModal" aria-hidden="true">
  <div class="modal-dialog">
    <h3>Schnell hinzuf√ºgen</h3>
    <form action="{{ url_for('add_entry_route') }}" method="post" novalidate>
      <input type="hidden" name="date" value="{{ today }}">
      <input type="hidden" name="type" value="expense" id="qm_type">
      <div class="form-grid">
        <label>
          <span>Kategorie</span>
          <select name="category" required>
            {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
          </select>
        </label>
        <label>
          <span>Betrag (‚Ç¨)</span>
          <input type="text" name="amount" placeholder="z. B. 12,34" inputmode="decimal" required>
        </label>
        <label class="full">
          <span>Notiz</span>
          <input type="text" name="note" placeholder="optional">
        </label>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button class="btn btn-primary" type="submit">Speichern</button>
        <button class="btn btn-ghost" type="button" id="qmCancel">Abbrechen</button>
        <label class="chip" title="Als Einnahme markieren" style="margin-left:auto;">
          <input type="checkbox" id="qmIncome">
          <span>Einnahme</span>
        </label>
      </div>
    </form>
  </div>
</div>

<script>
  // Quick Add modal
  const fab = document.getElementById('fabAdd');
  const modal = document.getElementById('quickModal');
  const cancel = document.getElementById('qmCancel');
  const chkIncome = document.getElementById('qmIncome');
  const typeField = document.getElementById('qm_type');

  const openM = () => { modal.setAttribute('aria-hidden','false'); };
  const closeM = () => { modal.setAttribute('aria-hidden','true'); chkIncome.checked=false; typeField.value='expense'; };

  fab && fab.addEventListener('click', openM);
  cancel && cancel.addEventListener('click', closeM);
  modal && modal.addEventListener('click', (e) => { if(e.target === modal) closeM(); });
  chkIncome && chkIncome.addEventListener('change', () => {
    typeField.value = chkIncome.checked ? 'income' : 'expense';
  });
</script>

{% endblock %}
