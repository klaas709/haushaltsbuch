{% extends "base.html" %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-list">
      {% for cat, msg in messages %}
        <div class="flash {{ cat }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="hero">
  <h1>Ãœbersicht & Erfassung</h1>
  <p class="muted">BetrÃ¤ge im deutschen Format: <code>2.100</code> oder <code>12,34</code> â€” Vorzeichen wird Ã¼ber <em>Einnahme/Ausgabe</em> gesetzt.</p>
</section>

<!-- Neuer Eintrag -->
<section class="card">
  <h2>â• Neuer Eintrag</h2>
  <form class="form-grid" action="{{ url_for('add_entry_route') }}" method="post" novalidate>
    <label>
      <span>Datum</span>
      <input type="date" name="date" value="{{ today }}" required>
    </label>
    <label>
      <span>Kategorie</span>
      <select name="category" required>
        <option value="" disabled selected>Bitte wÃ¤hlenâ€¦</option>
        {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
      </select>
    </label>
    <label class="full">
      <span>Art</span>
      <div class="type-toggle">
        <label><input type="radio" name="type" value="income"> Einnahme</label>
        <label><input type="radio" name="type" value="expense"> Ausgabe</label>
      </div>
    </label>
    <label>
      <span>Betrag (â‚¬)</span>
      <input type="text" name="amount" placeholder="z. B. 2.100 oder 12,34" inputmode="decimal" required>
    </label>
    <label class="full">
      <span>Notiz (optional)</span>
      <input type="text" name="note" placeholder="z. B. Wocheneinkauf">
    </label>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Speichern</button>
    </div>
  </form>
</section>

<!-- Filter -->
<section class="card">
  <h2>ğŸ” Filter</h2>
  <form class="filters" action="{{ url_for('home') }}" method="get">
    <label>
      <span>Kategorie</span>
      <select name="category">
        <option value="">Alle</option>
        {% for c in categories %}<option value="{{ c }}" {% if filters.category == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
      </select>
    </label>
    <label>
      <span>Art</span>
      <div class="chip-toggle">
        <label class="chip"><input type="radio" name="type" value="" {% if not filters.type %}checked{% endif %}><span>Alle</span></label>
        <label class="chip"><input type="radio" name="type" value="income" {% if filters.type == 'income' %}checked{% endif %}><span>Einnahmen</span></label>
        <label class="chip"><input type="radio" name="type" value="expense" {% if filters.type == 'expense' %}checked{% endif %}><span>Ausgaben</span></label>
      </div>
    </label>
    <label>
      <span>Datum von</span>
      <input type="date" name="date_from" value="{{ filters.date_from }}">
    </label>
    <label>
      <span>Datum bis</span>
      <input type="date" name="date_to" value="{{ filters.date_to }}">
    </label>
    <label class="full">
      <span>Textsuche (Notiz enthÃ¤lt)</span>
      <input type="text" name="q" placeholder="z. B. 'Supermarkt' oder 'Miete'" value="{{ filters.q }}">
    </label>
    <div class="actions">
      <button class="btn" type="submit">Filtern</button>
      <a class="btn btn-ghost" href="{{ url_for('home') }}">ZurÃ¼cksetzen</a>
      <a class="btn" href="{{ url_for('export_csv') }}{% if query_str %}?{{ query_str }}{% endif %}">CSV exportieren</a>
    </div>
  </form>
  <p class="muted" style="margin-top:8px;">{{ result_count }} Ergebnis{{ '' if result_count == 1 else 'se' }} gefunden.</p>
</section>

<!-- Ãœbersicht -->
<section class="card">
  <h2>ğŸ“Š Ãœbersicht</h2>
  <div class="summary">
    <div><strong>Einnahmen:</strong> <span class="pos">{{ total_income|euro }} â‚¬</span></div>
    <div><strong>Ausgaben:</strong> <span class="neg">{{ total_expense|euro }} â‚¬</span></div>
    <div><strong>Saldo:</strong> {{ balance|euro }} â‚¬</div>
  </div>

  {% if entries and entries|length > 0 %}
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Kategorie</th>
            <th class="right">Betrag</th>
            <th>Notiz</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entries %}
            <tr>
              <td>{{ e.date }}</td>
              <td>
                <span class="badge badge-cat">{{ e.category }}</span>
              </td>
              <td class="right {{ 'neg' if e.amount < 0 else 'pos' }}">{{ e.amount|euro }} â‚¬</td>
              <td>{{ e.note }}</td>
              <td class="actions">
                <a class="btn btn-small" href="{{ url_for('edit_entry', entry_id=e.id) }}">âœ Bearbeiten</a>
                <form action="{{ url_for('delete_entry_route', entry_id=e.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Diesen Eintrag wirklich lÃ¶schen?');">
                  <button class="btn btn-small btn-ghost" type="submit">ğŸ—‘ LÃ¶schen</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty">
      <div class="empty-illustration">ğŸ“­</div>
      <p class="muted">Keine EintrÃ¤ge fÃ¼r die aktuelle Filterauswahl. Lege oben einen neuen Eintrag an.</p>
    </div>
  {% endif %}
</section>

<!-- Alle EintrÃ¤ge lÃ¶schen -->
<section class="card danger">
  <h2>Alle EintrÃ¤ge lÃ¶schen</h2>
  <p class="muted">
    Hier kannst du <strong>alle</strong> deine EintrÃ¤ge unwiderruflich lÃ¶schen.
    Zur BestÃ¤tigung gib bitte dein Passwort ein.
  </p>
  <form action="{{ url_for('clear_entries') }}" method="post" class="form-inline" novalidate>
    <input type="password" name="password" placeholder="Passwort" required>
    <button class="btn btn-danger" type="submit"
            onclick="return confirm('Wirklich ALLE EintrÃ¤ge lÃ¶schen? Dieser Vorgang kann nicht rÃ¼ckgÃ¤ngig gemacht werden.');">
      Alle EintrÃ¤ge lÃ¶schen
    </button>
  </form>
</section>

{% endblock %}
