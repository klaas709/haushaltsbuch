{% extends "base.html" %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-list">
      {% for cat, msg in messages %}
        <div class="flash {{ cat }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="card">
  <h2>Profil</h2>
  <p class="muted">Passe deine Kontodaten und Budgets an. √Ñnderungen werden mit deinem aktuellen Passwort best√§tigt.</p>

  <form class="form-grid" action="{{ url_for('profile_post') }}" method="post" novalidate>
    <h3 class="full">Account</h3>

    <label>
      <span>Name</span>
      <input type="text" name="name" value="{{ user.name }}" required>
    </label>

    <label>
      <span>E-Mail</span>
      <input type="email" name="email" value="{{ user.email }}" required>
    </label>

    <div class="full"></div>

    <details class="full">
      <summary><strong>Passwort √§ndern (optional)</strong></summary>
      <div class="form-grid" style="margin-top:10px;">
        <label>
          <span>Neues Passwort</span>
          <input type="password" name="new_password" minlength="8">
        </label>
        <label>
          <span>Best√§tigung</span>
          <input type="password" name="confirm" minlength="8">
        </label>
      </div>
    </details>

    <h3 class="full" style="margin-top:8px;">Budgets pro Kategorie (Monat)</h3>
    {% for c in categories %}
      <label>
        <span>{{ c }} (Euro/Monat)</span>
        <input type="text" name="budget_{{ c }}" value="{{ (budgets.get(c) if budgets else '')|default('', true)|euro if budgets and budgets.get(c) else '' }}" placeholder="z. B. 250,00">
      </label>
    {% endfor %}

    <label class="full" style="margin-top:8px;">
      <span>Aktuelles Passwort (zur Best√§tigung)</span>
      <input type="password" name="current_password" required>
    </label>

    <div class="actions">
      <button class="btn" type="submit">√Ñnderungen speichern</button>
    </div>
  </form>
</section>

<section class="card">
  <h2>‚ü≥ Wiederkehrende Eintr√§ge</h2>
  <p class="muted">Automatische Buchungen in regelm√§√üigen Intervallen (z.‚ÄØB. Miete monatlich).</p>

  <form class="form-grid" action="{{ url_for('recurring_add') }}" method="post" novalidate>
    <label>
      <span>Startdatum</span>
      <input type="date" name="r_start" required>
    </label>
    <label>
      <span>Intervall</span>
      <div class="form-inline">
        <input type="number" name="r_value" min="1" value="1" style="width:100px">
        <select name="r_unit" required>
          <option value="month" selected>Monat(e)</option>
          <option value="week">Woche(n)</option>
          <option value="day">Tag(e)</option>
        </select>
      </div>
    </label>
    <label>
      <span>Kategorie</span>
      <select name="r_category" required>
        {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
      </select>
    </label>
    <label>
      <span>Betrag (mit Vorzeichen)</span>
      <input type="text" name="r_amount" placeholder="-950,00 f√ºr Miete / +300,00 f√ºr Einkommen" required>
    </label>
    <label class="full">
      <span>Notiz</span>
      <input type="text" name="r_note" placeholder="optional">
    </label>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Hinzuf√ºgen</button>
    </div>
  </form>

  {% if recurring and recurring|length > 0 %}
    <div class="table-wrapper" style="margin-top:12px;">
      <table class="table">
        <thead>
          <tr>
            <th>Start</th>
            <th>Intervall</th>
            <th>Kategorie</th>
            <th class="right">Betrag</th>
            <th>Notiz</th>
            <th>Zuletzt erzeugt</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recurring %}
            <tr>
              <td>{{ r.start_date }}</td>
              <td>{{ r.interval_value }} {{ 'Monat(e)' if r.interval_unit=='month' else 'Woche(n)' if r.interval_unit=='week' else 'Tag(e)' }}</td>
              <td><span class="badge">{{ r.category }}</span></td>
              <td class="right {{ 'neg' if r.amount < 0 else 'pos' }}">{{ r.amount|euro }} ‚Ç¨</td>
              <td>{{ r.note }}</td>
              <td>{{ r.last_applied or '‚Äì' }}</td>
              <td class="actions">
                <form action="{{ url_for('recurring_delete', r_id=r.id) }}" method="post" onsubmit="return confirm('Wiederkehrenden Eintrag l√∂schen?');">
                  <button class="btn btn-small btn-ghost" type="submit">üóë L√∂schen</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top:8px;">Noch keine wiederkehrenden Eintr√§ge.</p>
  {% endif %}
</section>

{% endblock %}
