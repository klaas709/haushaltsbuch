<!doctype html>
<html lang="de" data-menu-open="false" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{{ title if title else "Haushaltsbuch" }}</title>

  <!-- Styles (Cache-Busting) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=16">

  <!-- PWA: Manifest & Theme -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta id="meta-theme-color" name="theme-color" content="#0b1220">

  <!-- Icons / Favicon -->
  <link rel="icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <!-- Mobile: Hamburger -->
      <button class="nav-toggle" aria-label="MenÃ¼ Ã¶ffnen" id="menuBtn">â˜°</button>

      <!-- Brand mit Logo -->
      <a href="{{ url_for('home') }}" class="brand-wrap">
        <img class="brand-logo" src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="" />
        <div class="brand">
          {{ app_name or "Haushaltsbuch" }}
          <span class="brand-sub">Light</span>
        </div>
      </a>

      <!-- Theme Toggle -->
      <button id="theme-toggle" class="nav-toggle" title="Theme wechseln">ðŸŒ“</button>

      <!-- Desktop-Navigation -->
      <nav class="nav desktop-only">
        <button id="theme-toggle" aria-label="Theme umschalten">ðŸŒ“</button>
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('home') }}" class="nav-link">Start</a>
          <a href="{{ url_for('profile') }}" class="nav-link">Profil</a>
          {% if current_user.is_admin %}
            <a href="{{ url_for('admin_users') }}" class="nav-link">Admin</a>
          {% endif %}
          <span class="nav-user">ðŸ‘¤ {{ current_user.name }}</span>
          <a href="{{ url_for('logout') }}" class="nav-link">Abmelden</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="nav-link">Anmelden</a>
          <a href="{{ url_for('register') }}" class="nav-link">Registrieren</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <!-- Mobile Drawer -->
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="brand">Haushaltsbuch</div>
      <button class="nav-toggle" aria-label="MenÃ¼ schlieÃŸen" id="closeBtn">âœ•</button>
    </div>
    <nav class="drawer-nav">
      {% if current_user.is_authenticated %}
        <a href="{{ url_for('home') }}" class="drawer-link">Start</a>
        <a href="{{ url_for('profile') }}" class="drawer-link">Profil</a>
        {% if current_user.is_admin %}
          <a href="{{ url_for('admin_users') }}" class="drawer-link">Admin</a>
        {% endif %}
        <span class="drawer-user">ðŸ‘¤ {{ current_user.name }}</span>
        <a href="{{ url_for('logout') }}" class="drawer-link">Abmelden</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="drawer-link">Anmelden</a>
        <a href="{{ url_for('register') }}" class="drawer-link">Registrieren</a>
      {% endif %}
    </nav>
  </aside>
  <div class="backdrop" id="backdrop"></div>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>v1.8 â€¢ Lernprojekt von Jonas</small>
    </div>
  </footer>

  <!-- PWA: Service Worker Registration -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.warn("Service Worker registration failed:", err));
    }
  </script>

  <!-- Theme Bootstrap & Toggle -->
  <script>
    (function initTheme() {
      const saved = localStorage.getItem('theme');
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      const theme = saved || (prefersLight ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', theme);
      const meta = document.getElementById('meta-theme-color');
      if (meta) meta.setAttribute('content', theme === 'light' ? '#ffffff' : '#0b1220');
    })();
    document.addEventListener('click', (e) => {
      if (e.target && (e.target.id === 'theme-toggle' || e.target.closest('#theme-toggle'))) {
        const html = document.documentElement;
        const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        const meta = document.getElementById('meta-theme-color');
        if (meta) meta.setAttribute('content', next === 'light' ? '#ffffff' : '#0b1220');
      }
    });
  </script>

  <!-- Mobile Drawer Controls -->
  <script>
    const html = document.documentElement;
    const menuBtn = document.getElementById('menuBtn');
    const closeBtn = document.getElementById('closeBtn');
    const backdrop = document.getElementById('backdrop');
    const toggle = (open) => html.setAttribute('data-menu-open', open ? 'true' : 'false');

    menuBtn && menuBtn.addEventListener('click', () => toggle(true));
    closeBtn && closeBtn.addEventListener('click', () => toggle(false));
    backdrop && backdrop.addEventListener('click', () => toggle(false));
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggle(false); });
  </script>
</body>
</html>
